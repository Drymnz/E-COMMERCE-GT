<div class="container mt-4">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="bi bi-credit-card me-2"></i>
        Registrar Nueva Tarjeta
      </h5>
    </div>
    <div class="card-body">
      @if (mensaje) {
        <div class="alert alert-dismissible fade show"
             [ngClass]="{'alert-success': tipoMensaje === 'success', 'alert-danger': tipoMensaje === 'error'}"
             role="alert">
          <i class="bi" [ngClass]="{'bi-check-circle-fill': tipoMensaje === 'success', 'bi-exclamation-triangle-fill': tipoMensaje === 'error'}"></i>
          {{ mensaje }}
        </div>
      }

      <form [formGroup]="tarjetaForm" (ngSubmit)="registrarTarjeta()">
        <!-- Número de tarjeta -->
        <div class="mb-3">
          <label for="numero" class="form-label">
            <i class="bi bi-credit-card-2-front me-1"></i>
            Número de Tarjeta
          </label>
          <input 
            type="text" 
            class="form-control form-control-lg"
            [ngClass]="{'is-invalid': numeroInvalido}"
            id="numero"
            formControlName="numero"
            (input)="formatearNumero($event)"
            placeholder="1234567890123456"
            maxlength="16">
          @if (numeroInvalido) {
            <div class="invalid-feedback">
              Ingrese un número de tarjeta válido (16 dígitos)
            </div>
          }
          <small class="form-text text-muted">Ingrese los 16 dígitos de su tarjeta</small>
        </div>

        <div class="row">
          <!-- CVV -->
          <div class="col-md-6 mb-3">
            <label for="cvv" class="form-label">
              <i class="bi bi-shield-lock me-1"></i>
              CVV
            </label>
            <div class="input-group">
              <input 
                [type]="mostrarCVV ? 'text' : 'password'"
                class="form-control"
                [ngClass]="{'is-invalid': cvvInvalido}"
                id="cvv"
                formControlName="cvv"
                (input)="formatearCVV($event)"
                placeholder="123"
                maxlength="4">
              <button 
                class="btn btn-outline-secondary" 
                type="button"
                (click)="toggleMostrarCVV()">
                <i class="bi" [ngClass]="mostrarCVV ? 'bi-eye-slash' : 'bi-eye'"></i>
              </button>
              @if (cvvInvalido) {
                <div class="invalid-feedback">
                  CVV debe tener 3 o 4 dígitos
                </div>
              }
            </div>
            <small class="form-text text-muted">Código de seguridad (3-4 dígitos)</small>
          </div>

          <!-- Fecha de vencimiento -->
          <div class="col-md-6 mb-3">
            <label for="fechaVencimiento" class="form-label">
              <i class="bi bi-calendar-event me-1"></i>
              Fecha de Vencimiento
            </label>
            <input 
              type="month"
              class="form-control"
              [ngClass]="{'is-invalid': fechaInvalida}"
              id="fechaVencimiento"
              formControlName="fechaVencimiento">
            @if (fechaInvalida) {
              <div class="invalid-feedback">
                @if (tarjetaForm.get('fechaVencimiento')?.hasError('fechaVencida')) {
                  <span>La tarjeta está vencida</span>
                }
                @if (tarjetaForm.get('fechaVencimiento')?.hasError('required')) {
                  <span>La fecha es requerida</span>
                }
              </div>
            }
          </div>
        </div>

        <!-- Saldo inicial -->
        <div class="mb-4">
          <label for="saldo" class="form-label">
            <i class="bi bi-cash-stack me-1"></i>
            Saldo Inicial
          </label>
          <div class="input-group">
            <span class="input-group-text">Q</span>
            <input 
              type="number" 
              class="form-control"
              [ngClass]="{'is-invalid': saldoInvalido}"
              id="saldo"
              formControlName="saldo"
              placeholder="0.00"
              step="0.01"
              min="0">
            @if (saldoInvalido) {
              <div class="invalid-feedback">
                El saldo debe ser mayor o igual a 0
              </div>
            }
          </div>
          <small class="form-text text-muted">Ingrese el saldo disponible en su tarjeta</small>
        </div>

        <!-- Botones -->
        <div class="d-flex gap-2 justify-content-end">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="onCancelar()"
            [disabled]="loading">
            <i class="bi bi-x-circle me-1"></i>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="loading || tarjetaForm.invalid">
            @if (loading) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            } @else {
              <i class="bi bi-save me-1"></i>
            }
            {{ loading ? 'Registrando...' : 'Registrar Tarjeta' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>