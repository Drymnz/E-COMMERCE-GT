<div class="container mt-4 mb-5">
  <!-- Info del usuario -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="alert alert-light">
        <i class="bi bi-person-circle me-2"></i>
        <strong>Comprando como:</strong> {{ nombreUsuario }}
        <small class="text-muted ms-2">({{ usuarioActual()?.email }})</small>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  @if (mensaje()) {
  <div
    class="alert alert-dismissible fade show"
    [ngClass]="{
      'alert-success': tipoMensaje() === 'success',
      'alert-danger': tipoMensaje() === 'error',
      'alert-warning': tipoMensaje() === 'warning'
    }"
    role="alert"
  >
    <i
      class="bi"
      [ngClass]="{
        'bi-check-circle-fill': tipoMensaje() === 'success',
        'bi-exclamation-triangle-fill':
          tipoMensaje() === 'error' || tipoMensaje() === 'warning'
      }"
    ></i>
    {{ mensaje() }}
    <button type="button" class="btn-close" (click)="mensaje.set('')"></button>
  </div>
  }

  <!-- Indicadores de pasos -->
  <div class="row mb-4">
    <div class="col-12">
      <div
        class="d-flex justify-content-between align-items-center position-relative"
      >
        <div class="progress-line"></div>

        <div
          class="step-indicator text-center"
          [ngClass]="{ active: pasoActual() >= 1, completed: pasoActual() > 1 }"
        >
          <div class="step-circle">
            @if (pasoActual() > 1) {
            <i class="bi bi-check-lg"></i>
            } @else {
            <span>1</span>
            }
          </div>
          <small class="d-block mt-2">Resumen</small>
        </div>

        <div
          class="step-indicator text-center"
          [ngClass]="{ active: pasoActual() >= 2, completed: pasoActual() > 2 }"
        >
          <div class="step-circle">
            @if (pasoActual() > 2) {
            <i class="bi bi-check-lg"></i>
            } @else {
            <span>2</span>
            }
          </div>
          <small class="d-block mt-2">Pago</small>
        </div>

        <div
          class="step-indicator text-center"
          [ngClass]="{ active: pasoActual() >= 3 }"
        >
          <div class="step-circle">
            <span>3</span>
          </div>
          <small class="d-block mt-2">Confirmación</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Columna principal -->
    <div class="col-lg-8">
      <!-- Resumen del pedido -->
      @if (pasoActual() === 1) {
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-cart-check me-2"></i>
            Resumen de tu Pedido
          </h5>
        </div>
        <div class="card-body">
          @if (itemsCarrito().length === 0) {
          <div class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <p class="mt-3">Tu carrito está vacío</p>
          </div>
          } @else {
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Artículo</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-end">Precio Unit.</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                @for (item of itemsCarrito(); track item.articulo.id_articulo) {
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      @if (item.articulo.imagen) {
                      <img
                        [src]="item.articulo.imagen"
                        [alt]="item.articulo.nombre"
                        class="img-thumbnail me-3"
                        style="width: 60px; height: 60px; object-fit: cover"
                      />
                      }
                      <div>
                        <strong>{{ item.articulo.nombre }}</strong>
                        <br />
                        <small class="text-muted">{{
                          item.articulo.descripcion
                        }}</small>
                      </div>
                    </div>
                  </td>
                  <td class="text-center align-middle">
                    <span class="badge bg-secondary">{{ item.cantidad }}</span>
                  </td>
                  <td class="text-end align-middle">
                    Q {{ item.articulo.precio | number : "1.2-2" }}
                  </td>
                  <td class="text-end align-middle">
                    <strong
                      >Q {{ calcularSubtotal(item) | number : "1.2-2" }}</strong
                    >
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          }
        </div>
      </div>
      }

      <!--Selección/Registro de tarjeta -->
      @if (pasoActual() === 2) {
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="bi bi-credit-card me-2"></i>
            Método de Pago
          </h5>
        </div>
        <div class="card-body">
          @if (loadingTarjetas()) {
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Cargando tarjetas...</p>
          </div>
          } @else { @if (!mostrarRegistroTarjeta()) { @if
          (tarjetasUsuario().length > 0) {
          <h6 class="mb-3">Seleccione una tarjeta:</h6>
          <div class="row">
            @for (tarjeta of tarjetasUsuario(); track tarjeta.numero) {
            <div class="col-md-6 mb-3">
              <div
                class="card tarjeta-item position-relative"
                [ngClass]="{
                  selected: tarjetaSeleccionada()?.numero === tarjeta.numero
                }"
              >
                <!-- Botón eliminar  -->
                <button
                  type="button"
                  class="btn btn-sm btn-danger position-absolute"
                  style="top: 8px; right: 8px; z-index: 10; opacity: 0.9;"
                  (click)="abrirConfirmacionEliminar(tarjeta); $event.stopPropagation()"
                  [disabled]="eliminandoTarjeta()"
                  title="Eliminar tarjeta"
                >
                  <i class="bi bi-trash"></i>
                </button>

                <div class="card-body" (click)="seleccionarTarjeta(tarjeta)" role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <i
                        class="bi bi-credit-card-2-front fs-3 text-primary"
                      ></i>
                    </div>
                    @if (tarjetaSeleccionada()?.numero === tarjeta.numero) {
                    <i class="bi bi-check-circle-fill text-success fs-4"></i>
                    }
                  </div>
                  <h6 class="mt-3 mb-2">{{ tarjeta.numeroEnmascarado }}</h6>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <small class="text-muted">
                      Vence: {{ tarjeta.fecha_vencimiento | date : "MM/yyyy" }}
                    </small>
                    <span class="badge bg-success">
                      Q {{ tarjeta.saldo | number : "1.2-2" }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            }
          </div>

          <hr />

          <button
            class="btn btn-outline-primary"
            (click)="toggleRegistroTarjeta()"
          >
            <i class="bi bi-plus-circle me-2"></i>
            Agregar nueva tarjeta
          </button>
          } @else {
          <div class="text-center py-4">
            <i class="bi bi-credit-card-2-back display-4 text-muted"></i>
            <p class="mt-3">No tienes tarjetas registradas</p>
            <button class="btn btn-primary" (click)="toggleRegistroTarjeta()">
              <i class="bi bi-plus-circle me-2"></i>
              Registrar tarjeta
            </button>
          </div>
          } } @else {
          <app-registrar-tarjeta
            [idUsuario]="idUsuario()"
            (tarjetaRegistrada)="onTarjetaRegistrada($event)"
            (cancelar)="toggleRegistroTarjeta()"
          >
          </app-registrar-tarjeta>
          } }
        </div>
      </div>
      }

      <!-- Confirmación -->
      @if (pasoActual() === 3) {
      <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-check-circle me-2"></i>
            Confirmar Pago
          </h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Verifica que toda la información sea correcta antes de confirmar.
          </div>

          <h6 class="mb-3">Artículos a comprar:</h6>
          <ul class="list-group mb-4">
            @for (item of itemsCarrito(); track item.articulo.id_articulo) {
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
            >
              <span>
                <strong>{{ item.articulo.nombre }}</strong>
                <small class="text-muted ms-2">(x{{ item.cantidad }})</small>
              </span>
              <span class="badge bg-primary rounded-pill">
                Q {{ calcularSubtotal(item) | number : "1.2-2" }}
              </span>
            </li>
            }
          </ul>

          <h6 class="mb-3">Método de pago:</h6>
          @if (tarjetaSeleccionada()) {
          <div class="card bg-light">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <i class="bi bi-credit-card-2-front fs-3 text-primary me-3"></i>
                <div>
                  <strong>{{
                    tarjetaSeleccionada()!.numeroEnmascarado
                  }}</strong>
                  <br />
                  <small class="text-muted">
                    Saldo disponible: Q
                    {{ tarjetaSeleccionada()!.saldo | number : "1.2-2" }}
                  </small>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>

    <!-- Resumen de pago -->
    <div class="col-lg-4">
      <div class="card shadow sticky-top" style="top: 20px">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">
            <i class="bi bi-receipt me-2"></i>
            Resumen de Pago
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <strong>Q {{ totalCompra() | number : "1.2-2" }}</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Envío:</span>
            <strong class="text-success">Gratis</strong>
          </div>
          <hr />
          <div class="d-flex justify-content-between mb-3">
            <h5 class="mb-0">Total:</h5>
            <h5 class="mb-0 text-primary">
              Q {{ totalCompra() | number : "1.2-2" }}
            </h5>
          </div>

          @if (tarjetaSeleccionada() && pasoActual() >= 2) {
          <div class="alert alert-light mb-3">
            <small class="d-block">
              <i class="bi bi-credit-card me-1"></i>
              <strong>Tarjeta:</strong> ****
              {{ tarjetaSeleccionada()!.ultimosDigitos }}
            </small>
            <small class="d-block mt-1">
              <i class="bi bi-wallet2 me-1"></i>
              <strong>Saldo:</strong> Q
              {{ tarjetaSeleccionada()!.saldo | number : "1.2-2" }}
            </small>
          </div>
          }

          <div class="d-grid gap-2">
            @if (pasoActual() === 1) {
            <button class="btn btn-primary btn-lg" (click)="avanzarPaso()">
              Continuar al Pago
              <i class="bi bi-arrow-right ms-2"></i>
            </button>
            } @if (pasoActual() === 2) {
            <button
              class="btn btn-primary btn-lg"
              (click)="avanzarPaso()"
              [disabled]="!tarjetaSeleccionada() || loadingTarjetas()"
            >
              Continuar
              <i class="bi bi-arrow-right ms-2"></i>
            </button>
            <button
              class="btn btn-outline-secondary"
              (click)="retrocederPaso()"
            >
              <i class="bi bi-arrow-left me-2"></i>
              Volver
            </button>
            } @if (pasoActual() === 3) {
            <button
              class="btn btn-success btn-lg"
              (click)="abrirConfirmacionPago()"
              [disabled]="loading()"
            >
              @if (loading()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
              Procesando... } @else {
              <i class="bi bi-check-circle me-2"></i>
              Confirmar Pago }
            </button>
            <button
              class="btn btn-outline-secondary"
              (click)="retrocederPaso()"
              [disabled]="loading()"
            >
              <i class="bi bi-arrow-left me-2"></i>
              Volver
            </button>
            }

            <button
              class="btn btn-outline-danger"
              (click)="abrirConfirmacionCancelacion()"
              [disabled]="loading()"
            >
              <i class="bi bi-x-circle me-2"></i>
              Cancelar Compra
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmación de Cancelación -->
<app-notify-confirm
  [mostrar]="mostrarConfirmacionCancelacion()"
  titulo="Cancelar Compra"
  mensaje="¿Está seguro de que desea cancelar la compra?"
  mensajeSecundario="Perderá todos los artículos seleccionados en el carrito"
  textoConfirmar="Sí, cancelar"
  textoCancelar="No, continuar"
  tipoAlerta="warning"
  iconoAlerta="bi-exclamation-triangle-fill"
  [mostrarAdvertencia]="true"
  textoAdvertencia="Los artículos permanecerán en el carrito para una futura compra"
  (confirmar)="cancelarCompra()"
  (cancelar)="cerrarConfirmacionCancelacion()"
>
</app-notify-confirm>

<!-- Confirmación de Pago -->
<app-notify-confirm
  [mostrar]="mostrarConfirmacionPago()"
  titulo="Confirmar Pago"
  [mensaje]="'Está a punto de realizar un pago de Q ' + (totalCompra() | number : '1.2-2')"
  [mensajeSecundario]="'Se debitará de la tarjeta **** ' + (tarjetaSeleccionada()?.ultimosDigitos || '')"
  textoConfirmar="Confirmar y Pagar"
  textoCancelar="Revisar"
  tipoAlerta="info"
  iconoAlerta="bi-credit-card-fill"
  [mostrarAdvertencia]="true"
  textoAdvertencia="Asegúrese de que toda la información sea correcta antes de proceder"
  (confirmar)="procesarPago()"
  (cancelar)="cerrarConfirmacionPago()"
>
</app-notify-confirm>

<!-- Eliminación de Tarjeta -->
<app-notify-confirm
  [mostrar]="mostrarConfirmacionEliminar()"
  titulo="Eliminar Tarjeta"
  [mensaje]="'¿Está seguro de que desea eliminar la tarjeta **** ' + (tarjetaAEliminar()?.ultimosDigitos || '') + '?'"
  mensajeSecundario="Esta tarjeta será eliminada permanentemente de su cuenta"
  textoConfirmar="Sí, eliminar"
  textoCancelar="Cancelar"
  tipoAlerta="danger"
  iconoAlerta="bi-trash-fill"
  [mostrarAdvertencia]="true"
  textoAdvertencia="Esta acción no se puede deshacer. Si tiene pagos pendientes, no podrá recuperar esta tarjeta."
  (confirmar)="eliminarTarjeta()"
  (cancelar)="cerrarConfirmacionEliminar()"
>
</app-notify-confirm>